<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Firebase Chat (Full)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body { background: linear-gradient(180deg,#0f172a 0%, #071032 100%); color:white; }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(8px); }
    .scroll-auto { overflow-y:auto; }
  </style>
</head>
<body class="min-h-screen p-6">
  <div id="root"></div>

  <script type="text/babel">
const { useState, useEffect, useRef } = React;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAZsF7_B7FaM_oLDHbLXO0HEB-QEOccN2o",
  authDomain: "pages-4fe21.firebaseapp.com",
  databaseURL: "https://pages-4fe21-default-rtdb.firebaseio.com",
  projectId: "pages-4fe21",
  storageBucket: "pages-4fe21.firebasestorage.app",
  messagingSenderId: "713235884971",
  appId: "1:713235884971:web:39499d51066a71da75c0ee",
  measurementId: "G-LR795Y4WXR"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// App component
function App() {
  const [user, setUser] = useState(null);
  const [username, setUsername] = useState("");
  const [channels, setChannels] = useState([]);
  const [selectedChannel, setSelectedChannel] = useState(null);
  const [messages, setMessages] = useState([]);
  const [announcement, setAnnouncement] = useState(null);

  useEffect(() => {
    const unsub = auth.onAuthStateChanged(async u => {
      setUser(u);
      if (u) {
        const snap = await db.ref(`users/${u.uid}`).get();
        if (snap.exists()) {
          const data = snap.val();
          if (data.banned) {
            alert("あなたはBANされています");
            auth.signOut();
            return;
          }
          setUsername(data.username);
          loadChannels();
        }
      } else {
        setUsername("");
      }
    });
    return () => unsub();
  }, []);

  const loadChannels = () => {
    db.ref("channels").on("value", snap => {
      const val = snap.val() || {};
      const arr = Object.entries(val).map(([id, c]) => ({ id, ...c }));
      setChannels(arr);
      if (!selectedChannel && arr.length) setSelectedChannel(arr[0].id);
    });
  };

  // Messages listener
  const messagesEndRef = useRef(null);
  useEffect(() => {
    if (!selectedChannel) return;
    const ref = db.ref(`messages/${selectedChannel}`);
    ref.on("value", snap => {
      const val = snap.val() || {};
      const arr = Object.entries(val).map(([id, m]) => ({ id, ...m }));
      setMessages(arr);
      scrollToBottom();
      // 既読登録
      if (user) db.ref(`users/${user.uid}/lastRead/${selectedChannel}`).set(arr.length ? arr[arr.length-1].id : "");
    });
    return () => ref.off();
  }, [selectedChannel, user]);

  const scrollToBottom = () => {
    setTimeout(() => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 50);
  };

  // Announcement
  useEffect(() => {
    db.ref("announcement").on("value", snap => setAnnouncement(snap.val()));
  }, []);

  const sendMessage = text => {
    if (!user || !selectedChannel) return;
    db.ref(`messages/${selectedChannel}`).push({
      by: username,
      text,
      ts: Date.now()
    });
  };

  const logout = () => auth.signOut();

  return (
    <div className="max-w-6xl mx-auto grid grid-cols-12 gap-6">
      <div className="col-span-12 md:col-span-3 glass rounded-2xl p-4">
        <Header username={username} onLogout={logout}/>
        <hr className="my-3 border-white/10" />
        {user
          ? <React.Fragment>
              <Channels channels={channels} selected={selectedChannel} onSelect={setSelectedChannel} />
              {username === "Admin" && <AdminPanel />}
            </React.Fragment>
          : <AuthBox />
        }
      </div>

      <div className="col-span-12 md:col-span-9 glass rounded-2xl p-4 flex flex-col h-[75vh]">
        {announcement && (
          <div className="mb-2 p-3 bg-yellow-500/10 border border-yellow-400 rounded-md">
            <div className="text-sm font-bold">Announcement</div>
            <div className="text-sm">{announcement.text}</div>
          </div>
        )}
        <div className="flex-1 p-3 bg-white/5 rounded-lg scroll-auto">
          {messages.map(m => (
            <div key={m.id} className="mb-2">
              <div className="text-xs text-white/60">{m.by} - {new Date(m.ts).toLocaleTimeString()}</div>
              <div>{m.text}</div>
            </div>
          ))}
          <div ref={messagesEndRef}></div>
        </div>
        {user && <Composer onSend={sendMessage}/>}
      </div>
    </div>
  );
}

// Header
function Header({username, onLogout}) {
  return (
    <div className="flex justify-between items-center mb-2">
      <h1 className="text-xl font-bold">Firebase Chat</h1>
      {username && (
        <button onClick={onLogout} className="text-sm bg-red-600 px-2 py-1 rounded hover:bg-red-700">
          Logout
        </button>
      )}
    </div>
  );
}

// AuthBox with invite code
function AuthBox() {
  const [mode, setMode] = useState("login");
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [inviteCode, setInviteCode] = useState("");
  const [error, setError] = useState("");

  const submit = async () => {
    try {
      setError("");
      const fakeEmail = `${username}@chat.local`;

      if (mode === "register") {
        // 招待コードチェック
        const snap = await db.ref(`inviteCodes/${inviteCode}`).get();
        if (!snap.exists() || !snap.val().valid) {
          setError("無効な招待コードです");
          return;
        }
      }

      if (mode === "login") {
        await auth.signInWithEmailAndPassword(fakeEmail, password);
      } else {
        const userCred = await auth.createUserWithEmailAndPassword(fakeEmail, password);
        await db.ref(`users/${userCred.user.uid}`).set({ username, banned:false });
      }
    } catch (e) { setError(e.message); }
  };

  return (
    <div className="mt-3">
      <div className="flex gap-2 bg-white/5 rounded p-1">
        <button onClick={()=>setMode('login')} className={`flex-1 py-1 rounded ${mode==='login'?'bg-white/10':''}`}>Login</button>
        <button onClick={()=>setMode('register')} className={`flex-1 py-1 rounded ${mode==='register'?'bg-white/10':''}`}>Register</button>
      </div>
      <input value={username} onChange={e=>setUsername(e.target.value)} placeholder="Username" className="w-full mt-2 px-3 py-2 rounded bg-white/10"/>
      <input value={password} onChange={e=>setPassword(e.target.value)} type="password" placeholder="Password" className="w-full mt-2 px-3 py-2 rounded bg-white/10"/>
      {mode==='register' && <input value={inviteCode} onChange={e=>setInviteCode(e.target.value)} placeholder="Invite code" className="w-full mt-2 px-3 py-2 rounded bg-white/10"/>}
      {error && <div className="text-xs text-red-400 mt-1">{error}</div>}
      <button onClick={submit} className="w-full mt-3 py-2 rounded bg-indigo-600">{mode==='login'?'Login':'Register'}</button>
      <div className="text-xs text-white/60 mt-2">Admin: Admin / AdminPassword</div>
    </div>
  );
}

// Channels
function Channels({channels, selected, onSelect}) {
  return (
    <div className="mt-3">
      <div className="text-sm font-semibold mb-2">Channels</div>
      <div className="space-y-1">
        {channels.map(c => (
          <button key={c.id} onClick={()=>onSelect(c.id)} className={`block w-full text-left px-3 py-1 rounded ${selected===c.id?'bg-white/10':'hover:bg-white/5'}`}>#{c.name}</button>
        ))}
      </div>
    </div>
  );
}

// Composer
function Composer({onSend}) {
  const [text, setText] = useState("");
  const send = () => { if(text.trim()){onSend(text.trim()); setText("");} };
  return (
    <div className="mt-3 flex gap-2">
      <input value={text} onChange={e=>setText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Type a message..." className="flex-1 px-3 py-2 rounded bg-white/10"/>
      <button onClick={send} className="px-4 py-2 rounded bg-indigo-600">Send</button>
    </div>
  );
}

// Admin panel
function AdminPanel() {
  const [channelName,setChannelName]=useState("");
  const [announce,setAnnounce]=useState("");
  const [users,setUsers]=useState([]);
  const [invite,setInvite]=useState("");

  useEffect(()=>{
    db.ref("users").on("value",snap=>{
      const val=snap.val()||{};
      const arr=Object.entries(val).map(([uid,data])=>({uid,...data}));
      setUsers(arr);
    });
  },[]);

  const addChannel=()=>{ if(channelName){ const id=db.ref("channels").push().key; db.ref("channels/"+id).set({name:channelName}); setChannelName("");} };
  const postAnnouncement=()=>{ if(announce){ db.ref("announcement").set({text:announce, ts:Date.now()}); setAnnounce(""); } };
  const banUser=(uid)=>{ db.ref(`users/${uid}/banned`).set(true); };
  const deleteUser=async(uid)=>{
    try{
      await db.ref(`users/${uid}`).remove();
      alert("ユーザーを削除しました (Auth削除は管理者コンソールで実施)");
    }catch(e){alert(e.message);}
  };
  const addInviteCode=()=>{ if(invite){ db.ref(`inviteCodes/${invite}`).set({valid:true}); setInvite(""); alert("招待コード追加"); }};

  return (
    <div className="mt-4 p-3 bg-white/5 rounded-lg space-y-3">
      <div>
        <div className="text-sm font-semibold mb-1">Add Channel</div>
        <input value={channelName} onChange={e=>setChannelName(e.target.value)} placeholder="Channel name" className="w-full px-2 py-1 rounded bg-white/10"/>
        <button onClick={addChannel} className="w-full mt-2 py-1 bg-indigo-600 rounded">Add</button>
      </div>
      <div>
        <div className="text-sm font-semibold mb-1">Announcement</div>
        <textarea value={announce} onChange={e=>setAnnounce(e.target.value)} className="w-full p-2 rounded bg-white/10"></textarea>
        <button onClick={postAnnouncement} className="w-full mt-2 py-1 bg-yellow-600 rounded">Post</button>
      </div>
      <div>
        <div className="text-sm font-semibold mb-1">Invite Code</div>
        <input value={invite} onChange={e=>setInvite(e.target.value)} placeholder="Code" className="w-full px-2 py-1 rounded bg-white/10"/>
        <button onClick={addInviteCode} className="w-full mt-2 py-1 bg-green-600 rounded">Add Code</button>
      </div>
      <div>
        <div className="text-sm font-semibold mb-1">Users</div>
        <div className="space-y-1 max-h-40 overflow-auto">
          {users.map(u=>(
            <div key={u.uid} className="flex justify-between items-center bg-white/5 px-2 py-1 rounded">
              <span>{u.username} {u.banned?"(Banned)":""}</span>
              <div className="flex gap-1">
                {!u.banned && <button onClick={()=>banUser(u.uid)} className="bg-red-600 px-1 rounded text-xs">BAN</button>}
                <button onClick={()=>deleteUser(u.uid)} className="bg-gray-600 px-1 rounded text-xs">Delete</button>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
